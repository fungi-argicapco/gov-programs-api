#!/usr/bin/env bun
import { readFileSync, writeFileSync, mkdirSync } from 'node:fs';
import { join } from 'node:path';

const DATA_DIR = join(process.cwd(), 'data', 'climate_esg');
const SOURCE_CSV = join(DATA_DIR, 'climate_esg_sources.csv');
const OUTPUT_TS = join(process.cwd(), 'apps', 'ingest', 'src', 'datasets', 'climate_esg.ts');

function ensureOutputDir() {
  mkdirSync(join(process.cwd(), 'apps', 'ingest', 'src', 'datasets'), { recursive: true });
}

type CsvRow = Record<string, string>;

function parseCsv(content: string): CsvRow[] {
  const rows: CsvRow[] = [];
  const lines = content.split(/\r?\n/);
  if (lines.length === 0) return rows;
  const header = parseLine(lines[0]);
  for (let i = 1; i < lines.length; i += 1) {
    const line = lines[i];
    if (!line.trim()) continue;
    const values = parseLine(line);
    const row: CsvRow = {};
    for (let j = 0; j < header.length; j += 1) {
      row[header[j]] = values[j] ?? '';
    }
    rows.push(row);
  }
  return rows;
}

function parseLine(line: string): string[] {
  const result: string[] = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i += 1) {
    const char = line[i];
    if (inQuotes) {
      if (char === '"') {
        if (line[i + 1] === '"') {
          current += '"';
          i += 1;
        } else {
          inQuotes = false;
        }
      } else {
        current += char;
      }
    } else {
      if (char === '"') {
        inQuotes = true;
      } else if (char === ',') {
        result.push(current);
        current = '';
      } else {
        current += char;
      }
    }
  }
  result.push(current);
  return result;
}

function emitType(sample: CsvRow): string {
  const fields = Object.keys(sample).map((key) => `  ${key}: string;`);
  return `export type ClimateEsgSourceEntry = {\n${fields.join('\n')}\n};`;
}

function formatValue(value: string): string {
  const escaped = value.replace(/`/g, '\\`');
  return `\`${escaped}\``;
}

function serializeRows(rows: CsvRow[]): string[] {
  return rows.map((row) => {
    const parts = Object.entries(row).map(([key, value]) => `  ${key}: ${formatValue(value)}`);
    return `{\n${parts.join(',\n')}\n}`;
  });
}

function main() {
  ensureOutputDir();
  const csv = readFileSync(SOURCE_CSV, 'utf8');
  const rows = parseCsv(csv);
  if (rows.length === 0) {
    throw new Error('climate_esg_sources.csv produced no rows');
  }
  const typeDef = emitType(rows[0]);
  const objects = serializeRows(rows);
  const contents = `// Auto-generated by scripts/generate-climate-esg-dataset.ts\n// Do not edit by hand.\n\n${typeDef}\n\nexport const CLIMATE_ESG_SOURCES: readonly ClimateEsgSourceEntry[] = [\n${objects.join(',\n')}\n];\n`;
  writeFileSync(OUTPUT_TS, contents, 'utf8');
}

main();
