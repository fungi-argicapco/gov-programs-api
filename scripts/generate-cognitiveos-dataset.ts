#!/usr/bin/env bun
import { readFileSync, writeFileSync, mkdirSync } from 'node:fs';
import { join } from 'node:path';

const DATA_DIR = join(process.cwd(), 'data', 'cognitiveos_dataset');
const OUTPUT_FILE = join(process.cwd(), 'apps', 'ingest', 'src', 'datasets', 'cognitiveos.ts');

const FILES = [
  { name: 'partners', typeName: 'PartnerEntry' },
  { name: 'financial_assumptions', typeName: 'FinancialAssumptionEntry' },
  { name: 'capital_stack', typeName: 'CapitalStackEntry' },
  { name: 'roadmap', typeName: 'RoadmapEntry' },
  { name: 'services', typeName: 'DatasetServiceEntry' }
] as const;

type FileDef = typeof FILES[number];

function readJsonl(path: string): any[] {
  const raw = readFileSync(path, 'utf8');
  return raw
    .split(/\r?\n/)
    .map((line) => line.trim())
    .filter((line) => line.length > 0)
    .map((line) => JSON.parse(line));
}

function formatValue(value: unknown): string {
  if (typeof value === 'string') {
    const escaped = value.replace(/`/g, '\\`');
    return `\`${escaped}\``;
  }
  if (Array.isArray(value)) {
    return `[${value.map(formatValue).join(', ')}]`;
  }
  if (value === null) return 'null';
  return JSON.stringify(value, null, 2);
}

function mapObject(obj: Record<string, unknown>): string {
  const entries = Object.entries(obj).map(([key, value]) => `  ${key}: ${formatValue(value)}`);
  return `{
${entries.join(',\n')}
}`;
}

function inferFieldType(value: unknown): string {
  if (typeof value === 'string') return 'string';
  if (typeof value === 'number') return 'number';
  if (typeof value === 'boolean') return 'boolean';
  if (Array.isArray(value)) {
    if (value.length === 0) return 'readonly string[]';
    const subtype = inferFieldType(value[0]);
    return `readonly ${subtype}[]`;
  }
  if (value === null || value === undefined) return 'string | null';
  return 'unknown';
}

function emitType(name: string, sample: Record<string, unknown>): string {
  const fields = Object.entries(sample).map(([key, value]) => {
    const optional = value === null || value === undefined;
    const tsType = inferFieldType(value).replace('readonly ', '');
    return `  ${key}${optional ? '?' : ''}: ${tsType}${tsType.includes('[]') ? '' : ''};`;
  });
  return `export type ${name} = {
${fields.join('\n')}
};`;
}

function main() {
  mkdirSync(join(process.cwd(), 'apps', 'ingest', 'src', 'datasets'), { recursive: true });
  const chunks: string[] = [];
  chunks.push('// Auto-generated by scripts/generate-cognitiveos-dataset.ts');
  chunks.push('// Do not edit by hand.');
  chunks.push('');

  for (const file of FILES) {
    const jsonlPath = join(DATA_DIR, `${file.name}.jsonl`);
    const rows = readJsonl(jsonlPath);
    if (rows.length === 0) {
      throw new Error(`No rows in ${jsonlPath}`);
    }
    chunks.push(emitType(file.typeName, rows[0]));
    const objects = rows.map((row) => mapObject(row));
    const constName = file.name.toUpperCase();
    chunks.push(`export const ${constName}: readonly ${file.typeName}[] = [
${objects.join(',\n')}
];`);
    chunks.push('');
  }

  writeFileSync(OUTPUT_FILE, `${chunks.join('\n')}\n`, 'utf8');
}

main();
